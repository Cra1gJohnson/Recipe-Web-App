<% title = 'Recipe Finder' %>

<div class="container">
  <h1>Search Recipes by an Ingredient</h1>
  <% if (currentUser) { %>
    <h4>Current User: <%= currentUser.userName %></h4>
      <a href="/favorites" class="button">Favorites</a>
      <a href="/logOut" class="button">Log Out</a>
      
  <% } else { %>
    <p> 
      Welcome Guest User,<br>
      Feel free to search and view recipes. <br>
      Create an account to favorite recipes and revist them easily. 
    </p>
    <a href="/logIn" class="button">Log in</a>
    <a href="/register" class="button">Sign up</a>
  <% } %>

  <form action="/search" method="post">
    <input type="text" name="ingredients" placeholder="e.g. chicken, rice" required>
    <button type="submit">Find</button>
  </form>

  <% if (recipes != 0 && recipes != null) { %>
    <ul class="recipes">
      <% recipes.forEach(r => { %>
        <li>
          <a href="/search/<%= r.idMeal %>">
          <img src="<%= r.strMealThumb %>" alt="<%= r.strMeal %>">
          <h3><%= r.strMeal %></h3>
          </a>
          <% if (currentUser) { %>
            <form class="favorite-form">
              <input type="hidden" name="recipeId" value="<%= r.idMeal %>">
              <input type="hidden" name="title" value="<%= r.strMeal %>">
              <input type="hidden" name="image" value="<%= r.strMealThumb %>">
              <button type="submit">â™¥ Favorite</button>
            </form>
          <% } %>
        </li>
      <% }) %>
    </ul>
  <% } else if(recipes) { %>
    <h3> No Recipes Found </h3>
  <% } %>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.favorite-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // Stop full-page reload
      
      if (!confirm("Add this recipe to favorites?")) return;
      
      const formData = new FormData(form);
      const body = Object.fromEntries(formData.entries());
      
      try {
        const res = await fetch('/favorites', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          alert('Failed to add recipe.');
        }
      } catch (e) {
        console.error(e);
        alert('Error adding recipe.');
      }
    });
  });
});
</script>
